pipeline {
    agent any

    parameters {
        string(name: 'environment', defaultValue: 'default', description: 'Workspace/environment file to use for deployment')
        string(name: 'version', defaultValue: '', description: 'Version variable to pass to Terraform')
        booleanParam(name: 'autoApprove', defaultValue: false, description: 'Automatically run apply after generating plan?')
    }

    environment {
        AWS_ACCESS_KEY_ID     = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
        TF_IN_AUTOMATION      = '1'
    }


    stages {
        stage ("SCM checkout") {
            steps {
                git "https://github.com/Gitauwairimu/Java-DevOps-SonarQube.git"
                
            }
        }
        stage('IaC terraform Server Provisioning') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding', 
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID', 
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY',
                    credentialsId: 'circlecikey'
                ]]) {
                    sh 'terraformw apply -auto-approve -no-color'
                        }
                            
      }
    }


    //     stage(" Execute Ansible Playbook") {
    //        steps {
    //             ansiblePlaybook credentialsId: 'private-key', disableHostKeyChecking: true, installation: 'Ansible', inventory: 'inventory_aws_ec2.yaml', playbook: 'sonarQubedockerpluscompose.yaml'
    //         }    
    //     }    
    // }
}



